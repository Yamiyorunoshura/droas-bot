# Task-12 實作計畫：實現歷史查詢

**任務 ID**: Task-12
**任務名稱**: 實現歷史查詢
**創建日期**: 2025-10-06

## 需求對應

### 功能需求對應
- **F-005**: Transaction History - 用戶可以查看最近的交易歷史記錄

### 非功能需求對應
- **NFR-P-001**: Response Time - 95% 的指令需在 2 秒內響應
- **NFR-P-002**: Database Performance - 餘額查詢需在 500ms 內完成
- **NFR-U-001**: Error Messages - 90% 錯誤訊息提供明確解決方案

### 架構參照
- **Transaction Service**: 處理交易歷史查詢的核心業務邏輯
- **Database Layer**: 處理交易資料的持久化和查詢
- **Command Router**: 路由 !history 指令到對應服務
- **Message/UI Service**: 格式化交易歷史顯示
- **Cache Layer**: 優化查詢性能

## TDD 三階段實作

### RED 階段：定義測試與驗收

#### 驗收標準
1. **正常歷史查詢**
   - **驗收標準**: Given: 用戶有有效帳戶且至少有一筆交易，When: 用戶發送 !history 指令，Then: 系統返回嵌入消息顯示最近 10 筆交易，包含日期、類型、金額和交易對象
   - **測試條件**: 創建測試用戶，執行多筆交易，然後查詢歷史記錄
   - **成功指標**: 返回完整的嵌入消息，格式正確，按日期降序排列

2. **空歷史記錄處理**
   - **驗收標準**: Given: 用戶沒有交易歷史，When: 用戶發送 !history 指令，Then: 系統返回未找到交易的訊息
   - **測試條件**: 創建新用戶但不執行任何交易，直接查詢歷史
   - **成功指標**: 返回友好的「無交易記錄」消息

3. **性能要求**
   - **驗收標準**: 符合 NFR-P-001 和 NFR-P-002 要求
   - **測試條件**: 模擬有大量交易記錄的用戶進行查詢
   - **成功指標**: 查詢響應時間 < 500ms，總體響應時間 < 2秒

4. **邊緣情況處理**
   - **驗收標準**: 系統正確處理各種邊緣情況
   - **測試條件**: 測試用戶身份驗證、無效指令格式等
   - **成功指標**: 適當的錯誤處理和用戶友好的錯誤消息

#### 測試案例
1. **test_history_query_with_transactions**
   - **場景**: 用戶有多筆交易記錄時查詢歷史
   - **預期結果**: 返回包含最近 10 筆交易的嵌入消息

2. **test_history_query_no_transactions**
   - **場景**: 用戶沒有交易記錄時查詢歷史
   - **預期結果**: 返回「無交易記錄」的友好消息

3. **test_history_query_performance**
   - **場景**: 用戶有大量交易記錄時查詢歷史
   - **預期結果**: 響應時間符合性能要求

4. **test_history_query_invalid_user**
   - **場景**: 無效用戶嘗試查詢歷史
   - **預期結果**: 返回適當的錯誤消息

### GREEN 階段：最小實作步驟

#### 實作步驟
1. **擴展 Transaction Service**
   - **步驟**: 在 Transaction Service 中實現 get_transaction_history 方法
   - **檔案**: src/services/transaction_service.rs
   - **架構元件**: Transaction Service
   - **對應測試**: 正常歷史查詢測試

2. **實現資料庫查詢邏輯**
   - **步驟**: 在 Transaction Repository 中實現按用戶 ID 查詢最近交易的方法
   - **檔案**: src/database/transaction_repository.rs
   - **架構元件**: Database Layer
   - **對應測試**: 正常歷史查詢測試、性能測試

3. **添加歷史查詢命令路由**
   - **步驟**: 在 Command Router 中添加 !history 指令路由
   - **檔案**: src/command_router.rs
   - **架構元件**: Command Router
   - **對應測試**: 所有測試場景

4. **實現歷史查詢 UI 組件**
   - **步驟**: 創建格式化交易歷史顯示的嵌入消息組件
   - **檔案**: src/services/ui_components.rs
   - **架構元件**: Message/UI Service
   - **對應測試**: 正常歷史查詢測試、空歷史記錄測試

5. **集成快取機制**
   - **步驟**: 實現交易歷史快取以提升查詢性能
   - **檔案**: src/cache/mod.rs
   - **架構元件**: Cache Layer
   - **對應測試**: 性能測試

#### 需要修改的檔案
1. **src/services/transaction_service.rs**
   - **類型**: source
   - **修改**: update - 添加 get_transaction_history 方法

2. **src/database/transaction_repository.rs**
   - **類型**: source
   - **修改**: update - 添加 find_by_user_id_with_limit 方法

3. **src/command_router.rs**
   - **類型**: source
   - **修改**: update - 添加 !history 指令路由

4. **src/services/ui_components.rs**
   - **類型**: source
   - **修改**: update - 添加 create_history_embed 方法

5. **tests/transaction_service_test.rs**
   - **類型**: test
   - **修改**: create - 添加歷史查詢相關測試

### REFACTOR 階段：重構與優化

#### 優化目標
1. **程式碼重複消除**
   - **目標**: 統一查詢結果格式化邏輯
   - **質量改善**: 將分散在各處的嵌入消息創建邏輯抽象化
   - **合理性**: 提高程式碼可維護性，減少重複

2. **跨領域關注點整合**
   - **目標**: 整合日誌記錄、錯誤處理和性能監控
   - **質量改善**: 為歷史查詢添加結構化日誌、統一錯誤處理、響應時間監控
   - **合理性**: 提升系統可觀察性和除錯能力

3. **性能優化**
   - **目標**: 優化資料庫查詢和快取策略
   - **質量改善**: 實現查詢結果快取TTL、資料庫索引優化、分頁查詢支援
   - **合理性**: 滿足 NFR-P-001 和 NFR-P-002 性能要求

4. **架構改善**
   - **目標**: 提升 Transaction Service 的可擴展性
   - **質量改善**: 實現查詢參數化、支援不同歷史視圖（按類型、日期範圍等）
   - **合理性**: 為未來功能擴展做準備，提高靈活性

5. **測試覆蓋率提升**
   - **目標**: 增強測試的全面性和可靠性
   - **質量改善**: 添加集成測試、邊界測試、並發查詢測試
   - **合理性**: 確保在生產環境中的穩定性

#### 質量改善項目
1. **統一錯誤處理機制**
   - **改善**: 實現一致的錯誤消息格式和處理流程
   - **理由**: 提高用戶體驗和系統可維護性

2. **查詢結果快取策略**
   - **改善**: 實現智能快取機制，平衡性能與資料一致性
   - **理由**: 提升響應速度，減少資料庫負載

3. **結構化日誌記錄**
   - **改善**: 為歷史查詢操作添加詳細的結構化日誌
   - **理由**: 提升系統可觀察性和除錯效率

## 風險評估

### 識別的風險
1. **性能風險**
   - **描述**: 大量交易記錄查詢可能導致響應時間過長
   - **機率**: Medium
   - **影響**: High
   - **緩解措施**: 實現快取機制、資料庫索引優化、分頁查詢

2. **資料一致性風險**
   - **描述**: 歷史查詢可能顯示不完整的交易資料
   - **機率**: Low
   - **影響**: High
   - **緩解措施**: 使用資料庫事務、實現適當的鎖定機制

3. **依賴風險**
   - **描述**: 依賴 Task-11 的完成情況
   - **機率**: Low
   - **影響**: Medium
   - **緩解措施**: 確認 Task-11 已完成並通過所有測試

4. **使用者體驗風險**
   - **描述**: 歷史記錄格式可能不夠清晰
   - **機率**: Medium
   - **影響**: Medium
   - **緩解措施**: 使用標準化的嵌入消息格式，測試用戶反饋

## 任務依賴

此任務依賴以下已完成的任務：
- **Task-11**: 記錄交易歷史 - 必須先有交易記錄功能
- **Task-2**: 實現命令路由器 - 用於指令路由
- **Task-3**: 設置資料庫架構 - 用於資料持久化

## 驗收標準

- [ ] 所有測試案例通過
- [ ] 歷史查詢響應時間 < 500ms
- [ ] 正確顯示最近 10 筆交易記錄
- [ ] 適當處理空歷史記錄情況
- [ ] 符合 Discord 嵌入消息格式標準
- [ ] 實現適當的錯誤處理
- [ ] 集成快取機制
- [ ] 代碼覆蓋率 > 85%
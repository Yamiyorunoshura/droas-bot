# DROAS Discord 機器人系統 - 需求規格說明書

## 1. 專案資訊
- 名稱: DROAS Discord Bot System
- 版本: 1.0.0
- 描述: 以 Rust 編寫的 Discord 機器人系統，支援多子機器人與母機器人群組防護。
- 背景: 建立一個可擴展的多機器人架構，子機器人可各自連接 OpenAI Compatible LLM，並由母機器人提供群組防護與監管能力。
- 目標:
  - 支援初步 10 個子機器人實例
  - 透過 YAML 進行獨立配置與熱重載
  - 提供母機器人層的群組防護能力
  - 支援未來的工具調用與母子機器人交互

## 2. 功能性需求 (Functional Requirements)

### F-001 子機器人管理
- 描述: 系統可創建、啟動、停止、重啟最多 10 個子機器人實例。
- 優先級: 高
- 使用者故事: 作為系統管理者，我希望能管理多個子機器人，讓它們各自服務不同的群組與場景。
- 驗收標準:
  - 可同時運行最多 10 個子機器人
  - 支援對單一子機器人的啟停與重啟操作
  - 子機器人故障時自動重啟並上報母機器人
- 依賴: F-003

### F-002 群組防護（母機器人）
- 描述: 提供群組防護，包含垃圾訊息與自動刪除、重複訊息檢測、連結安全檢測、洗版行為檢測；自動禁言，禁言時間可由管理員調整。
- 優先級: 高
- 使用者故事: 作為群組管理員，我希望自動偵測與處理惡意或擾亂行為，維持群組品質。
- 驗收標準:
  - 可設定防護嚴格程度（如: 寬鬆/中等/嚴格）
  - 可針對垃圾訊息、重複訊息、連結安全進行檢測與自動處理
  - 可偵測洗版行為並自動禁言
  - 禁言時間可由管理員以指令或設定調整

### F-003 配置管理（YAML + 熱重載）
- 描述: 每個子機器人使用獨立 YAML 檔配置（包含 LLM base_url、api_key、discord bot token、系統提示詞），支援熱重載。
- 優先級: 高
- 使用者故事: 作為系統管理者，我希望能以 YAML 管理各子機器人的設定並在不重啟的情況下生效。
- 驗收標準:
  - 每個子機器人有獨立 YAML 檔
  - 修改後可在 10 秒內熱重載生效
  - 配置變更具備基本語法驗證與錯誤回報

### F-004 工具調用系統（母子交互）
- 描述: 子機器人可透過受控的工具調用介面，與母機器人的系統（例如：經濟系統）進行交互。
- 優先級: 中
- 使用者故事: 作為開發者，我希望子機器人能調用母機器人的服務，實現擴展功能。
- 驗收標準:
  - 提供標準化的工具調用介面（API/事件）
  - 工具調用端對端響應時間 ≤ 2 秒（正常負載）
  - 權限可控，並可審核調用紀錄

### F-005 監控與告警
- 描述: 提供系統與子機器人的運行監控、日誌記錄與告警機制。
- 優先級: 中
- 驗收標準:
  - 支援設定日誌等級（DEBUG/INFO/WARN/ERROR）
  - 暴露基本監控指標（訊息處理量、錯誤率、API 調用次數）
  - 告警條件可設定（例如：API 配額耗盡、連續錯誤）

## 3. 非功能性需求 (Non-functional Requirements)

### NFR-P-001 訊息處理性能
- 描述: 每個群組的訊息頻率為每分鐘數條，需在 5 秒內完成垃圾檢測與處理。
- 指標與測試: 在 2 核 CPU、4GB RAM 的雲主機上，模擬正常負載時 95 百分位處理時間 ≤ 5 秒。

### NFR-P-002 工具調用性能
- 描述: 子機器人與母機器人的工具調用需在 2 秒內完成回應（正常負載）。
- 指標與測試: 在 2 核 CPU、4GB RAM 環境下，端對端延遲 p95 ≤ 2 秒。

### NFR-R-001 可用性與恢復
- 描述: 系統應 24/7 運作，年度可用性 99%，子機器人故障自動重啟，並由母機器人通知錯誤事件。
- 測試方法: 混沌測試注入子機器人崩潰，驗證自動重啟與告警。

### NFR-S-001 安全性
- 描述: OpenAI API keys 與 Discord tokens 必須安全存放（加密或環境變數）。
- 機制: 支援以環境變數注入秘密；磁碟上存放時需加密；敏感資訊不得寫入普通日誌。

### NFR-O-001 可觀測性
- 描述: 系統需具備可觀測性，包括結構化日誌、指標與告警。
- 指標: 訊息處理量、錯誤率、API 調用次數、延遲分佈。
- 告警: 當 API 配額即將耗盡、錯誤率飆升、無法連線 Discord/LLM 時觸發。

### NFR-D-001 部署環境
- 描述: 部署於雲服務器（2 核 CPU、4GB RAM），暫不需多環境（dev/staging/prod）。

## 4. 限制條件 (Constraints)
- 技術: 使用 Rust；整合 Discord API；支援 OpenAI Compatible API。
- 業務: 初期 10 個子機器人；群組防護優先。
- 時間: 依開發排期；首版以最小可行功能為主。
- 預算: 依雲資源與 API 使用量計費。

## 5. 假設與相依 (Assumptions & Dependencies)
- 假設: Discord 伺服器與 API 穩定可用；OpenAI Compatible 服務可連線。
- 外部相依: Discord API、OpenAI Compatible API。
- 內部相依: 日後的母機器人經濟系統等服務。
- 風險: API 限流與配額、連結安全檢測誤判、垃圾訊息規則維護成本。

## 6. 測試需求 (Testing Requirements)
- 單元測試: 目標覆蓋率 ≥ 80%。
- 整合測試: 模擬 Discord 事件與 LLM 回應流程。
- 驗收測試: 依各 F-需求之驗收標準驗證。
- 效能測試: 壓測訊息頻率並驗證 p95 延遲指標。

## 7. 文件控管 (Document Control)
- 建立日期: 2025-09-11
- 最後修改: 2025-09-11
- 版本歷史:
  - 1.0.0: 初版需求文檔（作者: PM/Jason）
- 核准狀態: Draft


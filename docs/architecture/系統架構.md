## 系統架構


### 組件

#### 1. Discord Gateway 整合層
- **DiscordClient**: Serenity 客戶端封裝
- **CommandRegistry**: Slash Command 註冊和管理
- **InteractionHandler**: 交互事件處理
- **EventHandler**: Discord 事件監聽

#### 2. 命令路由和解析層
- **CommandRouter**: 命令路由核心
- **ParameterParser**: 參數解析和驗證
- **AuthMiddleware**: 權限驗證中間件
- **ValidationMiddleware**: 輸入驗證中間件

#### 3. 業務服務層
- **UserService**: 用戶帳戶管理服務
- **BalanceService**: 餘額查詢和管理服務
- **TransferService**: 轉帳處理服務
- **AdminService**: 管理調整服務
- **AuditService**: 稽核日誌服務
- **HelpService**: 說明系統服務
- **LeaderboardService**: 排行榜服務
- **ConfigService**: 伺服器配置服務

#### 4. 資料訪問層 (Repository 模式)
- **UserRepository**: 用戶資料 CRUD 操作
- **BalanceRepository**: 餘額資料操作
- **TransactionRepository**: 交易記錄操作
- **AuditRepository**: 稽核日誌操作
- **ConfigRepository**: 基本配置操作
- **ServerConfigRepository**: 伺服器特定配置操作

#### 5. 快取層
- **RedisCache**: Redis 快取實現
- **MemoryCache**: 記憶體快取後備
- **CacheManager**: 快取策略管理

#### 6. 監控和日誌層
- **MetricsCollector**: 性能指標收集
- **HealthChecker**: 健康檢查服務
- **Logger**: 結構化日誌記錄
- **ErrorHandler**: 集中式錯誤處理

### 資料流

```
Discord Event → Discord Gateway → Command Router → Auth Middleware
→ Validation Middleware → Business Service → Repository → Database
→ Cache Update → Response Builder → Discord Response
```

### 整合點
- **Discord API**: Slash Commands 和 Webhooks
- **PostgreSQL**: 主資料存儲
- **Redis**: 快取和會話存儲
- **Prometheus**: 指標收集
- **監控 HTTP 端點**: 健康檢查和指標暴露


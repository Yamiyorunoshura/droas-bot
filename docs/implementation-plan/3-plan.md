# Task-03 實施計劃 - 餘額查詢系統

## 任務上下文

**摘要**: 實現餘額查詢系統，支持查詢自己和他人的餘額，根據伺服器設定格式化顯示餘額，確保回應的私密性

**需求映射**:
- 功能需求: REQ-003 (查詢自己餘額), REQ-004 (查詢他人餘額), REQ-005 (餘額格式化顯示)
- 非功能需求: NFR-001 (指令響應時間 < 500ms), NFR-002 (資料庫查詢效能 < 100ms), NFR-006 (資料隱私)

**架構上下文**:
- 組件: BalanceService, BalanceRepository
- 整合點: PostgreSQL (主資料存儲), Redis (快取), Discord API (響應發送)
- 依賴: Task-01 (Discord Gateway整合), Task-02 (用戶帳戶管理系統)

## TDD階段規劃

### RED階段 - 測試設計

**目標**: 建立完整的餘額查詢測試框架，確保查詢功能、格式化顯示和私密性要求正確實現

**驗收標準到測試映射**:
1. 查詢自己餘額（私密回應）→ 自查詢測試
2. 查詢他人餘額（私密回應）→ 互查詢測試
3. 格式化顯示（小數位、千分位、貨幣符號）→ 格式化測試
4. 依伺服器設定顯示 → 配置集成測試

**測試用例**:
1. **自查詢測試**
   - 測試用戶查詢自己餘額成功
   - 測試私密回應只有用戶本人可見
   - 測試不存在用戶的處理
   - 測試查詢響應時間

2. **互查詢測試**
   - 測試查詢他人餘額成功
   - 測試私密回應只有查詢者可見
   - 測試查詢不存在用戶的處理
   - 測試查詢權限驗證

3. **格式化顯示測試**
   - 測試小數點後2位顯示
   - 測試千分位分隔符顯示
   - 測試貨幣符號顯示
   - 測試不同數值範圍格式化

4. **配置集成測試**
   - 測試伺服器配置正確應用
   - 測試配置變更實時生效
   - 測試默認配置處理
   - 測試無效配置處理

**測試文件**:
- `tests/balance_service/balance_service_test.rs`
- `tests/balance_service/balance_repository_test.rs`
- `tests/balance_service/formatting_test.rs`
- `tests/balance_service/privacy_test.rs`

### GREEN階段 - 最小實現

**目標**: 實現餘額查詢系統的最小可行功能，使所有測試通過

**實現步驟**:
1. **創建BalanceRepository數據訪問層**
   - 創建 `src/database/balance_repository.rs`
   - 實現餘額查詢方法
   - 添加緩存支持
   - 實現查詢優化

2. **實現BalanceService業務邏輯**
   - 創建 `src/services/balance_service.rs`
   - 實現自查詢邏輯
   - 實現互查詢邏輯
   - 添加權限檢查

3. **開發格式化顯示功能**
   - 創建 `src/utils/formatter.rs`
   - 實現數值格式化
   - 實現貨幣符號顯示
   - 實現千分位分隔符

4. **集成Discord Slash Command**
   - 實現 `/balance` 命令處理
   - 添加參數解析
   - 實現私密回應
   - 添加錯誤處理

5. **集成配置系統**
   - 實現配置讀取
   - 添加配置緩存
   - 實現配置驗證
   - 添加默認配置

**文件結構**:
- `src/database/balance_repository.rs`
- `src/services/balance_service.rs`
- `src/utils/formatter.rs`
- `src/commands/balance_command.rs`
- `src/services/mod.rs` (更新)

**依賴項**:
- SQLx (資料庫ORM)
- Redis (快取)
- Serenity (Discord集成)
- anyhow (錯誤處理)

### REFACTOR階段 - 重構和優化

**目標**: 提升查詢性能、格式化靈活性和代碼質量

**重構目標**:
1. **性能優化**
   - 實現查詢結果緩存
   - 優化資料庫查詢
   - 實現批量查詢支持
   - 添加預加載機制

2. **格式化系統改進**
   - 實現可配置格式化器
   - 添加多語言支持
   - 實現自定義格式
   - 優化格式化性能

3. **代碼結構優化**
   - 提取通用接口
   - 實現依賴注入
   - 添加配置管理
   - 改進錯誤處理

**質量改進**:
1. **監控和日誌**
   - 添加查詢性能監控
   - 實現查詢統計
   - 添加業務指標
   - 實現告警機制

2. **安全性增強**
   - 實現輸入驗證
   - 添加權限檢查
   - 實現頻率限制
   - 添加敏感數據保護

3. **用戶體驗改進**
   - 實現智能建議
   - 添加快捷操作
   - 實現歷史記錄
   - 優化響應格式

**檢查清單**:
- [ ] 所有測試通過並達到95%+覆蓋率
- [ ] 查詢響應時間 < 500ms
- [ ] 資料庫查詢時間 < 100ms
- [ ] 格式化顯示正確無誤
- [ ] 私密回應完全正確
- [ ] 配置系統靈活可用
- [ ] 代碼通過clippy檢查無警告

## 附加細節

**配置變更**:
- 添加貨幣符號配置
- 配置小數位數設置
- 設置千分位分隔符選項
- 配置查詢限制參數

**數據庫遷移**: 無（使用現有的users表）

**API文檔**:
- BalanceService接口文檔
- BalanceRepository API文檔
- 格式化工具文檔
- Discord Slash Command文檔

**安全考慮**:
- 輸入驗證和清理
- 權限驗證機制
- 頻率限制實現
- 敏感數據保護

## 風險管理

1. **查詢性能瓶頸**
   - 實現查詢緩存
   - 添加查詢優化
   - 實現分頁機制

2. **格式化顯示錯誤**
   - 實現格式化驗證
   - 添加默認格式
   - 實現錯誤恢復

3. **私密性洩露風險**
   - 實現嚴格權限檢查
   - 添加回應驗證
   - 實現審計日誌

## 驗證檢查清單

- [ ] 查詢自己餘額功能正常
- [ ] 查詢他人餘額功能正常
- [ ] 格式化顯示正確無誤
- [ ] 私密回應完全正確
- [ ] 配置系統正常工作
- [ ] 性能指標達到要求
- [ ] 安全性措施到位
- [ ] 監控和日誌完整
- [ ] 文檔齊全且準確

## 備註

此任務是用戶最常用的功能之一，需要特別注意性能優化和用戶體驗。格式化顯示的靈活性是關鍵特性，需要支持不同伺服器的個性化配置。私密性是核心要求，必須確保所有回應都是私密的。
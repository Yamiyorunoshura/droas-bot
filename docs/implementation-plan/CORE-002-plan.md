# CORE-002 實施計劃 - 公會成員加入事件處理

## 計劃概述

**任務ID**: CORE-002  
**任務名稱**: 公會成員加入事件處理  
**創建日期**: 2025-09-16  
**版本**: 1.0  
**狀態**: approved  

## 任務總覽

**描述**: 實現Discord公會成員加入事件的監聽和歡迎訊息發送功能，包括事件處理流水線架構和訊息發送邏輯。

**範圍**: 涵蓋GUILD_MEMBER_ADD事件監聽、事件驗證、公會配置查詢、歡迎訊息構建與發送的完整流程。

**目標**:
- 實現可靠的成員加入事件監聽機制
- 建立高效的歡迎訊息發送流程
- 確保3秒內完成訊息發送（P95目標）
- 提供穩健的錯誤處理和重試機制

## 需要閱讀的檔案

**上下文檔案**:
- `/docs/requirements/Functional Requirements.md` (行 1-107) - F-001功能需求詳細說明
- `/docs/architecture/System architecture.md` (行 1-44) - 系統架構圖和組件說明
- `/docs/tasks.md` (行 62-77) - CORE-002任務詳細分解

## 利害關係人

- **Product Owner**: Jason
  - 責任: requirements_validation, acceptance_criteria_approval
- **Development Team Leader**: [待指派]
  - 責任: technical_implementation, code_review
- **QA Team Leader**: [待指派]
  - 責任: quality_assurance, testing_strategy

## 詳細計劃

### 任務 001: 開發成員加入事件監聽器

**優先級**: high  
**複雜度**: medium  
**預估工作量**: 8小時 / 5故事點

#### 功能需求
- 實現GUILD_MEMBER_ADD事件處理程序 (對應F-001)
- 添加事件有效性驗證
- 建立事件處理流水線架構

#### 非功能需求
- 事件處理延遲 < 500ms (支援整體3秒目標)
- 99.5%事件處理成功率
- 安全的令牌處理，絕不記錄敏感資訊

#### 實施步驟
1. **步驟1**: 設置Gateway連接與權限意圖 (預估2小時)
   - 配置GUILD_MEMBERS intent
   - 實現Gateway連接管理
   - 添加連接狀態監控

2. **步驟2**: 實現事件處理框架 (預估3小時)
   - 建立事件路由機制
   - 實現事件驗證邏輯
   - 添加錯誤處理和日誌

3. **步驟3**: 建立事件處理流水線 (預估3小時)
   - 實現異步事件處理
   - 添加事件排隊機制
   - 集成監控和指標

#### 相關架構組件
- **Event Handler** (presentation層) - 新增功能
  - 負責接收和路由GUILD_MEMBER_ADD事件
- **Rate Limit & Retry** (business層) - 集成
  - 提供API呼叫保護機制
- **Dedup/Idempotency** (business層) - 集成
  - 防止重複事件處理

#### 設計模式
- **Event-Driven Pipeline**: 確保事件處理的可擴展性
- **Circuit Breaker**: 提供故障隔離和恢復機制

#### 需要修改的檔案
- `src/event_handler.rs` (source) - 創建 (預估150行)
- `src/gateway.rs` (source) - 創建 (預估100行)
- `tests/event_handler_test.rs` (test) - 創建 (預估80行)

#### 依賴關係
- **前置任務**: CORE-001 (機器人認證和連接管理)
- **並行任務**: CORE-004 (公會配置管理)
- **外部依賴**: Discord Gateway API (已確認)

#### 風險
- **風險001**: Discord Gateway連接不穩定
  - 機率: medium | 影響: high
  - 緩解策略: 實現指數退避重連機制
  - 應急計劃: 本地事件緩存和批量重放

#### 接受標準

**功能標準**:
- 成功監聽並處理GUILD_MEMBER_ADD事件 (測試方法: unit_test, 成功指標: 事件接收率100%)
- 事件有效性驗證通過 (測試方法: integration_test, 成功指標: 無效事件被過濾)

**非功能標準**:
- **性能**: 事件處理延遲 < 500ms (測試方法: load_test)
- **安全**: 無敏感資訊洩漏 (測試方法: security_scan)

#### 測試標準

**單元測試**: 覆蓋率目標90%, 測試案例數12
**集成測試**: 
- Discord Gateway連接測試
- 事件處理流水線測試
**端到端測試**:
- 完整成員加入流程驗證

---

### 任務 002: 實現歡迎訊息發送邏輯

**優先級**: high  
**複雜度**: medium  
**預估工作量**: 6小時 / 3故事點

#### 功能需求
- 加載公會特定歡迎頻道配置 (對應F-001, F-005)
- 構建歡迎訊息文本（包含成員提及）
- 實現訊息發送並處理結果

#### 非功能需求
- P95訊息發送延遲 <= 3000ms (NFR-P-002)
- HTTP 429回應正確處理和重試 (NFR-R-001)
- 冪等性處理，防止5分鐘內重複發送

#### 實施步驟
1. **步驟1**: 實現公會配置查詢 (預估2小時)
   - 集成Config Service
   - 實現配置緩存機制
   - 添加配置缺失處理

2. **步驟2**: 開發訊息構建邏輯 (預估2小時)
   - 實現訊息模板系統
   - 添加成員提及功能
   - 支援多語言歡迎文本

3. **步驟3**: 實現訊息發送和重試 (預估2小時)
   - 集成Discord REST API
   - 實現速率限制感知
   - 添加發送結果處理

#### 相關架構組件
- **Config Service** (business層) - 集成
  - 提供公會配置查詢
- **Rate Limit & Retry** (business層) - 集成
  - 處理API速率限制
- **SQLite Config DB** (data層) - 查詢
  - 存儲公會配置資料

#### 設計模式
- **Template Method**: 訊息構建的標準化流程
- **Retry Pattern**: 可靠的API呼叫機制

#### 需要修改的檔案
- `src/message_service.rs` (source) - 創建 (預估120行)
- `src/config_service.rs` (source) - 更新 (預估50行)
- `tests/message_service_test.rs` (test) - 創建 (預估70行)

#### 依賴關係
- **前置任務**: CORE-002任務001
- **並行任務**: 無
- **外部依賴**: Discord REST API (已確認), SQLite資料庫 (已確認)

#### 風險
- **風險002**: Discord API速率限制過於嚴格
  - 機率: medium | 影響: medium
  - 緩解策略: 智能退避和訊息佇列
  - 應急計劃: 降級到基本文字訊息

#### 接受標準

**功能標準**:
- 成功發送包含成員提及的歡迎訊息 (測試方法: integration_test, 成功指標: 訊息發送成功率95%)
- 正確處理未配置歡迎頻道的情況 (測試方法: unit_test, 成功指標: 記錄警告日誌)

**非功能標準**:
- **性能**: P95訊息發送延遲 <= 3000ms (測試方法: load_test)
- **可靠性**: 99.5%訊息發送可用性 (測試方法: chaos_test)

#### 測試標準

**單元測試**: 覆蓋率目標90%, 測試案例數10
**集成測試**:
- 完整配置查詢到訊息發送流程
- 錯誤情境和重試機制
**端到端測試**:
- 沙盒公會真實成員加入測試

---

## 里程碑追蹤

### 里程碑
1. **事件監聽器完成** (目標日期: Day 3)
   - 交付物: 工作的事件處理系統, 單元測試, 集成測試
   
2. **訊息發送實現完成** (目標日期: Day 5)
   - 交付物: 完整歡迎訊息功能, 性能測試報告, 部署包

### 成功指標
- **代碼品質**: A級 (透過靜態分析工具測量)
- **測試覆蓋率**: 90% (透過覆蓋率報告測量)
- **性能**: < 3000ms回應時間 (透過性能測試測量)

## 後續實施行動

### 文件更新
- **API文件**: 需要更新 (負責人: 開發者)
- **使用者手冊**: 不需要更新

### 監控設置
- **系統性能**: Prometheus/Grafana監控, 警報閾值 > 3秒
- **錯誤率**: 應用程式日誌監控, 警報閾值 > 1%

### 維護計劃
- **審查頻率**: 每週
- **負責團隊**: 開發團隊
- **更新觸發**: 性能下降, 安全漏洞, 功能要求

---

## 審查檢查點

1. **設計審查**
   - 審查者: 技術主管
   - 標準: 架構合規性, 性能考量

2. **代碼審查**
   - 審查者: 資深開發者
   - 標準: 代碼品質, 測試覆蓋率, 文件

3. **QA審查**
   - 審查者: QA主管
   - 標準: 測試完整性, 接受標準驗證

---

*本實施計劃基於需求文檔F-001、架構設計和任務分解CORE-002制定。所有里程碑檢查點必須完成後方可進入下一階段。*